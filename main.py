from sqlserver_connection import SQLServerConnection
import pandas as pd
import os
import re

def verificar_sql_server():
    """Verificar que SQL Server est√© corriendo y sea accesible"""
    print("üîç Verificando conexi√≥n a SQL Server...")
    
    try:
        db = SQLServerConnection(database='master')
        success = db.connect_pyodbc()
        
        if success:
            result = db.execute_query("SELECT @@VERSION as version", return_dataframe=True)
            if isinstance(result, pd.DataFrame) and not result.empty:
                version_info = result['version'].iloc[0][:50]
                print(f"‚úÖ SQL Server conectado exitosamente")
                print(f"   Versi√≥n: {version_info}...")
                db.close()
                return True
            else:
                print("‚ùå Error: No se pudo ejecutar consulta de prueba")
                db.close()
                return False
        else:
            print("‚ùå Error: No se pudo conectar a SQL Server")
            return False
            
    except Exception as e:
        print(f"‚ùå Error conectando a SQL Server: {e}")
        return False

def crear_base_datos_si_no_existe():
    """Crear la base de datos DGBIDB si no existe"""
    print("üîç Verificando base de datos DGBIDB...")
    
    try:
        db = SQLServerConnection(database='master')
        success = db.connect_pyodbc()
        
        if not success:
            print("‚ùå No se pudo conectar a la base de datos master")
            return False
        
        # Verificar si existe la base de datos
        if db.database_exists('DGBIDB'):
            print("‚úÖ Base de datos DGBIDB ya existe")
            db.close()
            return True
        else:
            print("üìä Creando base de datos 'DGBIDB'...")
            
            # Usar el m√©todo especial para CREATE DATABASE
            success = db.create_database('DGBIDB')
            
            if success:
                print("‚úÖ Base de datos DGBIDB creada exitosamente")
                db.close()
                return True
            else:
                print("‚ùå No se pudo crear la base de datos")
                db.close()
                return False
            
    except Exception as e:
        print(f"‚ùå Error con base de datos: {e}")
        if 'db' in locals():
            db.close()
        return False

def ejecutar_script_createdb():
    """Ejecutar el script createDB.sql"""
    print("\nüöÄ Ejecutando script createDB.sql...")
    
    script_path = "createDB.sql"
    
    # Verificar que existe el archivo
    if not os.path.exists(script_path):
        print(f"‚ùå No se encontr√≥ el archivo: {script_path}")
        print("üí° Aseg√∫rate de que est√© en el directorio ra√≠z del proyecto")
        return False
    
    try:
        # Leer el script SQL
        with open(script_path, 'r', encoding='utf-8') as file:
            script_content = file.read()
        
        print(f"üìã Script le√≠do correctamente ({len(script_content)} caracteres)")
        
        # Conectar a la base de datos DGBIDB
        db = SQLServerConnection(database='DGBIDB')
        success = db.connect_pyodbc()
        
        if not success:
            print("‚ùå No se pudo conectar a la base de datos DGBIDB")
            return False
        
        # Procesar el script dividiendo por GO
        statements = procesar_script_sql(script_content)
        
        print(f"üìä Se encontraron {len(statements)} declaraciones SQL para ejecutar")
        
        # Ejecutar cada declaraci√≥n
        ejecutadas = 0
        errores = 0
        
        for i, statement in enumerate(statements, 1):
            if statement.strip():
                try:
                    print(f"   üìù Ejecutando declaraci√≥n {i}/{len(statements)}...")
                    
                    # Ejecutar la declaraci√≥n usando el m√©todo raw
                    success = db.execute_raw_sql(statement)
                    
                    if success:
                        ejecutadas += 1
                        
                        # Mostrar informaci√≥n espec√≠fica seg√∫n el tipo de declaraci√≥n
                        if "CREATE TABLE" in statement.upper():
                            tabla_nombre = extraer_nombre_tabla(statement)
                            print(f"      ‚úÖ Tabla creada: {tabla_nombre}")
                        elif "CREATE VIEW" in statement.upper():
                            vista_nombre = extraer_nombre_vista(statement)
                            print(f"      ‚úÖ Vista creada: {vista_nombre}")
                        elif "INSERT INTO" in statement.upper():
                            tabla_nombre = extraer_tabla_insert(statement)
                            print(f"      ‚úÖ Datos insertados en: {tabla_nombre}")
                        elif "PRINT" in statement.upper():
                            mensaje = extraer_mensaje_print(statement)
                            if mensaje:
                                print(f"      üí¨ {mensaje}")
                        else:
                            print(f"      ‚úÖ Declaraci√≥n ejecutada")
                    else:
                        errores += 1
                        
                except Exception as e:
                    error_msg = str(e)
                    # Ignorar errores de objetos que ya existen
                    if any(x in error_msg.lower() for x in ["already exists", "ya existe", "duplicate"]):
                        print(f"      ‚ÑπÔ∏è Objeto ya existe (omitido)")
                        ejecutadas += 1
                    else:
                        print(f"      ‚ùå Error: {error_msg[:100]}...")
                        errores += 1
        
        print(f"\nüìä Resumen de ejecuci√≥n:")
        print(f"   ‚úÖ Declaraciones ejecutadas: {ejecutadas}")
        print(f"   ‚ùå Errores: {errores}")
        print(f"   üìã Total procesadas: {len(statements)}")
        
        db.close()
        return errores == 0
        
    except Exception as e:
        print(f"‚ùå Error ejecutando script: {e}")
        return False

def procesar_script_sql(script_content):
    """Procesar el script SQL dividiendo por GO"""
    
    # Remover comentarios de l√≠nea completa
    lines = script_content.split('\n')
    clean_lines = []
    
    for line in lines:
        # Mantener la l√≠nea si no es un comentario completo
        stripped = line.strip()
        if not stripped.startswith('--') or 'PRINT' in line.upper():
            clean_lines.append(line)
    
    cleaned_script = '\n'.join(clean_lines)
    
    # Dividir por GO (case insensitive)
    statements = re.split(r'\bGO\b', cleaned_script, flags=re.IGNORECASE)
    
    # Limpiar cada declaraci√≥n
    clean_statements = []
    for statement in statements:
        statement = statement.strip()
        if statement and not statement.startswith('--'):
            clean_statements.append(statement)
    
    return clean_statements

def extraer_nombre_tabla(statement):
    """Extraer nombre de tabla de CREATE TABLE"""
    try:
        match = re.search(r'CREATE TABLE\s+(?:dbo\.)?(\[?[\w_]+\]?)', statement, re.IGNORECASE)
        if match:
            return match.group(1).replace('[', '').replace(']', '')
        return "tabla_desconocida"
    except:
        return "tabla_desconocida"

def extraer_nombre_vista(statement):
    """Extraer nombre de vista de CREATE VIEW"""
    try:
        match = re.search(r'CREATE VIEW\s+(?:dbo\.)?(\[?[\w_]+\]?)', statement, re.IGNORECASE)
        if match:
            return match.group(1).replace('[', '').replace(']', '')
        return "vista_desconocida"
    except:
        return "vista_desconocida"

def extraer_tabla_insert(statement):
    """Extraer nombre de tabla de INSERT INTO"""
    try:
        match = re.search(r'INSERT INTO\s+(?:dbo\.)?(\[?[\w_]+\]?)', statement, re.IGNORECASE)
        if match:
            return match.group(1).replace('[', '').replace(']', '')
        return "tabla_desconocida"
    except:
        return "tabla_desconocida"

def extraer_mensaje_print(statement):
    """Extraer mensaje de PRINT"""
    try:
        match = re.search(r"PRINT\s+'([^']+)'", statement, re.IGNORECASE)
        if match:
            return match.group(1)
        return None
    except:
        return None

def verificar_estructura_creada():
    """Verificar la estructura final creada"""
    print("\nüîç Verificando estructura creada...")
    
    try:
        db = SQLServerConnection(database='DGBIDB')
        success = db.connect_pyodbc()
        
        if not success:
            print("‚ùå No se pudo conectar para verificar estructura")
            return False
        
        # Contar tablas
        tablas_query = """
        SELECT COUNT(*) as total_tablas
        FROM INFORMATION_SCHEMA.TABLES 
        WHERE TABLE_SCHEMA = 'dbo'
        """
        result_tablas = db.execute_query(tablas_query, return_dataframe=True)
        total_tablas = result_tablas['total_tablas'].iloc[0] if isinstance(result_tablas, pd.DataFrame) else 0
        
        # Contar vistas
        vistas_query = """
        SELECT COUNT(*) as total_vistas
        FROM INFORMATION_SCHEMA.VIEWS 
        WHERE TABLE_SCHEMA = 'dbo'
        """
        result_vistas = db.execute_query(vistas_query, return_dataframe=True)
        total_vistas = result_vistas['total_vistas'].iloc[0] if isinstance(result_vistas, pd.DataFrame) else 0
        
        print(f"üìä Estructura verificada:")
        print(f"   üìã Tablas creadas: {total_tablas}")
        print(f"   üëÅÔ∏è Vistas creadas: {total_vistas}")
        
        # Mostrar algunas tablas importantes
        tablas_importantes = [
            '25_ENTES',
            'Bienes_01_BENEFICIARIOS', 
            'Bienes_02_CARTERAS',
            'Concesiones_01_BENEFICIARIOS'
        ]
        
        print(f"\nüéØ Verificando tablas importantes:")
        for tabla in tablas_importantes:
            existe_query = f"""
            SELECT COUNT(*) as existe 
            FROM INFORMATION_SCHEMA.TABLES 
            WHERE TABLE_SCHEMA = 'dbo' AND TABLE_NAME = '{tabla}'
            """
            result = db.execute_query(existe_query, return_dataframe=True)
            existe = result['existe'].iloc[0] > 0 if isinstance(result, pd.DataFrame) else False
            status = "‚úÖ" if existe else "‚ùå"
            print(f"   {status} {tabla}")
        
        # Verificar datos de ejemplo
        if total_tablas > 0:
            print(f"\nüìä Verificando datos de ejemplo:")
            try:
                entes_query = "SELECT COUNT(*) as total FROM dbo.[25_ENTES]"
                entes_result = db.execute_query(entes_query, return_dataframe=True)
                total_entes = entes_result['total'].iloc[0] if isinstance(entes_result, pd.DataFrame) else 0
                print(f"   üìã Registros en ENTES: {total_entes}")
                
                if total_entes > 0:
                    print(f"\nüìã Primeros registros de ENTES:")
                    entes_data = db.execute_query("SELECT TOP 3 * FROM dbo.[25_ENTES]", return_dataframe=True)
                    if isinstance(entes_data, pd.DataFrame):
                        print(entes_data.to_string(index=False))
                        
            except Exception as e:
                print(f"   ‚ö†Ô∏è Error verificando datos: {e}")
        
        db.close()
        return True
        
    except Exception as e:
        print(f"‚ùå Error verificando estructura: {e}")
        return False

def main():
    """Funci√≥n principal"""
    print("üöÄ SISTEMA DE INICIALIZACI√ìN DE BASE DE DATOS")
    print("üìã Ejecutando script createDB.sql")
    print("=" * 60)
    
    try:
        # Paso 1: Verificar SQL Server
        if not verificar_sql_server():
            print("\n‚ùå SQL Server no est√° disponible")
            print("üí° Ejecuta: docker-compose up -d")
            return
        
        # Paso 2: Crear base de datos si no existe
        if not crear_base_datos_si_no_existe():
            print("‚ùå No se pudo preparar la base de datos")
            return
        
        # Paso 3: Ejecutar script createDB.sql
        if not ejecutar_script_createdb():
            print("‚ö†Ô∏è Hubo algunos errores ejecutando el script, pero puede haber funcionado parcialmente")
        
        # Paso 4: Verificar estructura creada
        verificar_estructura_creada()
        
        print("\n" + "=" * 60)
        print("üéâ ¬°PROCESO COMPLETADO!")
        print("\nüìä Informaci√≥n de conexi√≥n para DBeaver:")
        print("   üåê Host: localhost")
        print("   üîå Puerto: 1433")
        print("   üóÑÔ∏è Base de datos: DGBIDB")
        print("   üë§ Usuario: sa")
        print("   üîë Contrase√±a: MyStrongPass123!")
        
        print("\nüéØ ¬°Ya puedes conectarte y explorar la base de datos!")
        
    except Exception as e:
        print(f"\n‚ùå Error general: {e}")
        print("üí° Revisa que SQL Server est√© corriendo: docker ps")

if __name__ == "__main__":
    main()